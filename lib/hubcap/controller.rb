require 'hubcap/repo_collection'

module Hubcap
  
  set :views,  File.join(File.expand_path(File.dirname(__FILE__)), "views")
  set :public, File.join(File.expand_path(File.dirname(__FILE__)), "public")
  
  respond = lambda do
    
    if !params[:login].nil? && !params[:login].empty?
      
      if request.path_info == '/' && (params[:token].nil? || params[:token].empty?)
        redirect to("/#{params[:login]}")
      end

      begin
        @repos = RepoCollection.new(params.slice("login", "token").symbolize_keys)
        # sample_data = [{"name"=>"babushka-deps", "has_wiki"=>false, "size"=>1320, "created_at"=>"2010/02/01 22:13:47 -0800", "participation"=>[0, 0, 0, 0, 0, 2, 0, 3, 0, 0, 0, 0, 0, 5, 11, 10, 3, 0, 0, 0, 0, 0, 0, 0, 15, 22, 0, 0, 7, 30, 4, 0, 0, 0, 0, 0, 0, 0, 14, 0, 0, 9, 3, 5, 0, 0, 0, 0, 0, 2, 1, 0], "watchers"=>2, "private"=>false, "url"=>"https://github.com/chrisberkhout/babushka-deps", "language"=>"Ruby", "fork"=>false, "color"=>"#aec7e8", "pushed_at"=>"2011/05/02 21:03:58 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>false, "forks"=>2, "description"=>"Babushka Deps", "owner"=>"chrisberkhout"}, {"name"=>"scaffapp", "has_wiki"=>true, "size"=>1368, "created_at"=>"2010/06/25 00:30:54 -0700", "participation"=>[0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/scaffapp", "language"=>"Ruby", "fork"=>false, "color"=>"#1f77b4", "pushed_at"=>"2011/04/23 08:28:22 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>true, "forks"=>1, "description"=>"", "owner"=>"chrisberkhout"}, {"name"=>"dryft", "has_wiki"=>true, "size"=>992, "created_at"=>"2010/08/12 07:21:56 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "watchers"=>2, "private"=>false, "url"=>"https://github.com/chrisberkhout/dryft", "language"=>"Ruby", "fork"=>false, "color"=>"#ff7f0e", "pushed_at"=>"2011/01/19 06:35:11 -0800", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>true, "forks"=>2, "description"=>"DRYFT for WinAutomation", "owner"=>"chrisberkhout"}, {"name"=>"delicious_tools", "has_wiki"=>true, "size"=>516, "created_at"=>"2010/08/27 23:54:11 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/delicious_tools", "fork"=>false, "color"=>"#dbdb8d", "pushed_at"=>"2010/08/28 03:01:29 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>true, "forks"=>1, "description"=>"Delicious Tools for Chrome", "owner"=>"chrisberkhout"}, {"name"=>"taps-mssql-hack", "has_wiki"=>true, "size"=>364, "created_at"=>"2010/09/12 05:43:16 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "watchers"=>4, "private"=>false, "url"=>"https://github.com/chrisberkhout/taps-mssql-hack", "language"=>"Ruby", "fork"=>true, "color"=>"#ffbb78", "pushed_at"=>"2010/09/12 06:46:22 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>false, "forks"=>1, "description"=>"Fork of ricardochimal/taps, with a dodgy hack for pulling into MSSQL Server", "owner"=>"chrisberkhout"}, {"name"=>"cango", "has_wiki"=>true, "size"=>2032, "created_at"=>"2010/10/19 21:19:47 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 16, 6, 0, 6, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/cango", "language"=>"Ruby", "fork"=>false, "color"=>"#98df8a", "pushed_at"=>"2011/05/01 07:53:06 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>true, "forks"=>1, "description"=>"", "owner"=>"chrisberkhout"}, {"name"=>"ContentCleavage", "has_wiki"=>true, "size"=>484, "created_at"=>"2010/11/14 05:03:16 -0800", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 7, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/ContentCleavage", "language"=>"JavaScript", "fork"=>false, "color"=>"#2ca02c", "pushed_at"=>"2011/03/11 00:05:07 -0800", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>true, "forks"=>1, "description"=>"See the split between comments and primary content", "owner"=>"chrisberkhout"}, {"name"=>"qwandry", "has_wiki"=>true, "size"=>140, "created_at"=>"2010/12/11 07:37:48 -0800", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/qwandry", "fork"=>true, "color"=>"#d62728", "pushed_at"=>"2010/12/11 07:54:19 -0800", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"http://endofline.wordpress.com/2010/12/07/qwandry-is-the-new-open-gem/", "has_issues"=>false, "forks"=>0, "description"=>"Qwandry gives you a single way to easily open all your projects and libraries.", "owner"=>"chrisberkhout"}, {"name"=>"babushka", "has_wiki"=>true, "size"=>336, "created_at"=>"2011/01/15 23:25:11 -0800", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/babushka", "language"=>"Ruby", "fork"=>true, "color"=>"#ff9896", "pushed_at"=>"2011/01/17 21:34:13 -0800", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"http://babushka.me", "has_issues"=>false, "integrate_branch"=>"master", "forks"=>0, "description"=>"Test-driven sysadmin.", "owner"=>"chrisberkhout"}, {"name"=>"rag_deploy", "has_wiki"=>true, "size"=>1040, "created_at"=>"2011/04/18 06:46:50 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 16, 2, 4], "watchers"=>3, "private"=>false, "url"=>"https://github.com/chrisberkhout/rag_deploy", "language"=>"Ruby", "fork"=>false, "color"=>"#8c564b", "pushed_at"=>"2011/05/03 02:40:58 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>true, "forks"=>1, "description"=>"RAG Deploy", "owner"=>"chrisberkhout"}, {"name"=>"arel", "has_wiki"=>true, "size"=>5168, "created_at"=>"2011/04/27 03:42:39 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/arel", "language"=>"Ruby", "fork"=>true, "color"=>"#9467bd", "pushed_at"=>"2011/04/27 03:50:51 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>false, "forks"=>0, "description"=>"A Relational Algebra", "owner"=>"chrisberkhout"}, {"name"=>"hubcap", "has_wiki"=>true, "size"=>1168, "created_at"=>"2011/05/13 22:48:22 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 23, 24, 5, 0, 8], "watchers"=>2, "private"=>false, "url"=>"https://github.com/chrisberkhout/hubcap", "language"=>"JavaScript", "fork"=>false, "color"=>"#c5b0d5", "pushed_at"=>"2011/06/23 08:28:44 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"http://hubcap.heroku.com", "has_issues"=>true, "forks"=>1, "description"=>"A visual recap of your GitHub commits", "owner"=>"chrisberkhout"}, {"name"=>"npcr_for_anymemo", "has_wiki"=>true, "size"=>396, "created_at"=>"2011/05/30 05:59:14 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/npcr_for_anymemo", "language"=>"Ruby", "fork"=>false, "color"=>"#c49c94", "pushed_at"=>"2011/06/02 07:47:27 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>true, "forks"=>1, "description"=>"New Practical Chinese Reader vocabulary flashcards for AnyMemo", "owner"=>"chrisberkhout"}, {"name"=>"ffaker", "has_wiki"=>true, "size"=>220, "created_at"=>"2011/06/04 21:58:21 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/ffaker", "language"=>"Ruby", "fork"=>true, "color"=>"#e377c2", "pushed_at"=>"2011/06/04 23:00:48 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"http://github.com/emmanueloga/faker", "has_issues"=>false, "forks"=>0, "description"=>"Faker refactored. Cleaner. Faster.", "owner"=>"chrisberkhout"}, {"name"=>"guard", "has_wiki"=>true, "size"=>148, "created_at"=>"2011/06/13 03:33:31 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/guard", "language"=>"Ruby", "fork"=>true, "color"=>"#c7c7c7", "pushed_at"=>"2011/06/13 04:01:07 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"https://rubygems.org/gems/guard", "has_issues"=>false, "forks"=>0, "description"=>"Guard is a command line tool to easily handle events on files modifications (FSEvent / Inotify / Polling support).", "owner"=>"chrisberkhout"}, {"name"=>"htmlbeautifier", "has_wiki"=>true, "size"=>156, "created_at"=>"2011/06/13 09:52:47 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/htmlbeautifier", "language"=>"Ruby", "fork"=>true, "color"=>"#7f7f7f", "pushed_at"=>"2011/06/14 08:00:41 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"", "has_issues"=>false, "forks"=>0, "description"=>"A normaliser/beautifier for HTML that also understands embedded Ruby. Ideal for tidying up Rails templates.", "owner"=>"chrisberkhout"}, {"name"=>"elasticsearch.github.com", "has_wiki"=>true, "size"=>152, "created_at"=>"2011/06/24 05:28:31 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/elasticsearch.github.com", "language"=>"JavaScript", "fork"=>true, "color"=>"#bcbd22", "pushed_at"=>"2011/06/24 04:15:36 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"http://elasticsearch.com", "has_issues"=>false, "forks"=>0, "description"=>"", "owner"=>"chrisberkhout"}, {"name"=>"tire", "has_wiki"=>true, "size"=>116, "created_at"=>"2011/06/24 10:00:04 -0700", "participation"=>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], "watchers"=>1, "private"=>false, "url"=>"https://github.com/chrisberkhout/tire", "language"=>"Ruby", "fork"=>true, "color"=>"#f7b6d2", "pushed_at"=>"2011/06/24 10:19:31 -0700", "has_downloads"=>true, "open_issues"=>0, "homepage"=>"http://karmi.github.com/tire/", "has_issues"=>false, "forks"=>0, "description"=>"A rich Ruby API and DSL for the ElasticSearch search engine/database", "owner"=>"chrisberkhout"}]
        # @repos = RepoCollection.new(sample_data.map{|r| Repo.new(r) })
      rescue
        @error = true
      end
      
    end
    
    if @repos.nil?
      haml :index
    else
      haml :report
    end

  end

  get  '/',       &respond
  post '/',       &respond
  get  '/:login', &respond
  post '/:login', &respond

end
